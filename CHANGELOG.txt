CHANGELOG

### v3.8.0 - PyPI Package Distribution (Feb 2026)

#### Architecture
- **PyPI package:** yourSQLfriend is now installable via `pipx install yoursqlfriend`. Users type `yoursqlfriend` from any terminal to launch — no git clone, no manual venv, no `./run.sh` needed.
- **src/ layout:** Restructured into `src/yoursqlfriend/` Python package. All app code, static assets, templates, and ASCII art moved into the package directory. Existing `BASE_PATH` resolution via `__file__` required zero path logic changes.
- **pyproject.toml:** Added package metadata with hatchling build backend. Dependencies declared with minimum version pins (`flask>=3.0`, `pandas>=2.0`, `requests>=2.28`, `flask-session>=0.5`). Entry point: `yoursqlfriend = "yoursqlfriend:main"`.
- **Extracted `main()` function:** `app.py` `__main__` block extracted into a callable `main()` for use as a package entry point. `if __name__ == '__main__'` guard retained for direct execution.

#### Installer Scripts
- **Rewritten `install.sh` (Linux/macOS):** Now installs via pipx instead of downloading a tarball. Detects Python 3.10+, installs pipx if missing (pip → apt/dnf/pacman/brew fallbacks), runs `pipx install yoursqlfriend`. Supports `--update` flag for upgrades.
- **Rewritten `install.ps1` (Windows):** Same pipx-based flow adapted for PowerShell. Checks `python3`/`python`/`py` commands, installs pipx via pip, refreshes PATH within session.
- **Dev scripts updated:** `run.sh` and `run.bat` now use `pip install -e .` (editable install) instead of `pip install -r requirements.txt`, and launch via `python -m yoursqlfriend.app`.

#### CI/CD
- **GitHub Actions publish workflow:** `.github/workflows/publish.yml` triggers on version tags (`v*`). Builds sdist + wheel, publishes to PyPI via trusted publishers (OIDC) — no API tokens needed.

#### Tests
- **Updated imports:** Test file now imports from `yoursqlfriend.app` instead of using `sys.path.insert` hack. All 63 tests pass.

### v3.7.1 - Codebase Consolidation (Feb 2026)

#### Backend
- **Module-level constants:** Extracted `FORBIDDEN_QUERY_KEYWORDS`, `FORBIDDEN_SQL_FILE_KEYWORDS`, `MAX_UPLOAD_SIZE_BYTES`, `MAX_HISTORY_MESSAGES`, `MAX_STORED_MESSAGES`, `MAX_RESULT_ROWS` from inline definitions scattered across routes. Single source of truth for each value.
- **SQL execution helper:** Extracted `execute_and_parse_query()` and `update_chat_history_with_results()` — the `/execute_sql` route's initial and retry paths now share the same logic instead of duplicating it.
- **Unified LLM streaming:** Merged `stream_lmstudio_response()` and `stream_ollama_response()` into a single `stream_llm_response(messages, provider, model)`. Provider-specific config (URL, payload, timeout, JSON parsing) is handled via conditionals; shared logic (streaming loop, response accumulation, END_OF_STREAM, error handling) is written once.

#### Frontend
- **Modal factory:** Added `createModal(id, overlayClass, contentHTML, options)` to `ui.js` — handles remove-existing, overlay click, Escape key, close button, and initial focus. `showConfirmModal()`, `showSearchModal()`, and `showERDiagramModal()` refactored to use it.
- **Download utility:** Added `downloadBlob(blob, filename)` to `ui.js`. CSV export and chat export both use it instead of duplicating the objectURL/anchor/click/revoke pattern.
- **Chart cleanup export:** Added `destroyAllCharts()` to `charts.js`. `upload.js` imports it instead of inlining the Chart.js instance teardown.
- **Async/await consistency:** Converted `.then()/.catch()` chains in `upload.js` (`doUpload`), `notes.js` (save handler), and `app.js` (export chat) to `async/await`.

#### CSS
- **Shared modal overlay:** Added `.modal-overlay` base class with the 10 common positioning/backdrop properties. `.confirm-modal-overlay`, `.search-modal-overlay`, and `.er-modal-overlay` reduced to overrides only.

#### Fixes
- **Service worker stale cache:** Changed fetch strategy for app CSS/JS from cache-first to network-first with cache fallback. Vendored libs, fonts, and icons remain cache-first. Prevents stale JS modules from being served after code changes within the same version, which previously caused ES module import failures that broke the entire app.

### v3.7.0 - Architecture Overhaul (Feb 2026)

#### Security
- **Fixed forbidden keyword bypass (critical):** `validate_sql()` was checking forbidden keywords against raw SQL instead of stripped SQL, causing false positives on safe queries like `WHERE message LIKE '%DROP TABLE%'`. Now checks against the output of `strip_strings_and_comments()` as intended.
- **Fixed unclosed block comment edge case:** `strip_strings_and_comments()` now properly handles `/*` without a closing `*/`, preventing malicious content from hiding in unterminated comments.
- **Hardened SQL file import:** `execute_sql_file()` blocklist expanded with `ATTACH`, `LOAD_EXTENSION`, and `CREATE TRIGGER` to prevent filesystem access and trigger-based attacks from uploaded `.sql` files.

#### Architecture
- **ES module split:** Monolithic `script.js` (2,305 lines) split into 11 ES modules under `static/js/`: `app.js` (entry point), `state.js`, `ui.js`, `chat.js`, `sql.js`, `charts.js`, `upload.js`, `providers.js`, `search.js`, `notes.js`, `erdiagram.js`. No bundler — uses native `<script type="module">`. Each feature is independently readable and replaceable.
- **Self-hosted fonts:** Replaced Google Fonts `@import` with 7 vendored woff2 files in `static/fonts/` (JetBrains Mono 400–700, IBM Plex Sans 400–600). Eliminates render-blocking network request, Google tracking vector, and offline font failure. Uses `@font-face` with `font-display: swap`.
- **Test suite:** Added 63 pytest test cases for `validate_sql()` and `strip_strings_and_comments()` — the security boundary between user input and database execution. Covers allowed queries, all forbidden keywords, keywords in strings/comments, multi-statement detection, PRAGMA safety, and edge cases.

#### Performance
- **Schema context caching:** `build_schema_context()` result cached in session on upload, reused for all subsequent chat messages. Eliminates N redundant database connections per conversation.
- **`marked.setOptions()` called once:** Moved from per-render to init-time configuration.
- **Chat history cap:** Stored session history capped at 100 messages. Query result preview reduced from 20 to 5 rows for session storage.
- **CSS containment:** Added `contain: layout style` to `.sidebar` and `.main-chat` for paint performance.
- **Scan-line z-index:** Lowered from 9999 to 10 to reduce compositing overhead.

#### Reliability
- **`get_readonly_connection()` helper:** Extracted duplicated `sqlite3.connect(mode=ro)` + `PRAGMA query_only` pattern into single reusable function. Four call sites consolidated.
- **Context managers for all connections:** All database connections now use `with` statements, ensuring `conn.close()` on any exception type.
- **AbortController cleanup:** Rapid sends now abort the previous stream before starting a new one, preventing orphaned fetch connections.

#### Maintenance
- **Version injection via Jinja2:** Template cache-bust strings (`?v=`) now use `{{ version }}` from Flask instead of hardcoded values. Reduces manual version locations from 6 to 4.
- **Firefox scrollbar fix:** Changed `*` scrollbar selector to `html` — inherited anyway, avoids performance hit on deep DOM trees.
- **Service worker updated:** Cache list includes all ES module files and self-hosted font files.

### v3.6.1 - LLM Prompt Optimization (Feb 2026)

#### Optimized
- **Compact schema sample data:** Sample rows now use pipe-delimited format instead of verbose Python tuples. Long text values truncated at 50 characters.
- **Tighter system prompt:** Compressed instruction rules and few-shot examples to reduce token overhead on every request.
- **Lightweight error correction:** Auto-retry prompts now send schema DDL + foreign keys only, skipping sample data that isn't needed for fixing SQL errors.
- **Chat history cleanup:** Only `role` and `content` fields are sent to the LLM — metadata like query result previews, UUIDs, and token usage stats are stripped. History capped at 20 messages to prevent unbounded context growth.

### v3.6.0 - UX Improvements (Feb 2026)

#### Features
- **Clickable example queries:** Welcome screen examples now populate the chat input on click instead of being static text.
- **CSV export:** "CSV" download button on every query result table for exporting data directly.
- **Auto-growing textarea:** Chat input upgraded from single-line input to a textarea that grows up to 6 lines. Shift+Enter inserts newlines, Enter sends.
- **Chat input history:** Up/Down arrow keys recall previously sent messages, terminal-style.
- **Scroll-to-bottom button:** Floating "↓" button appears when scrolled up in chat, click to jump to latest message.
- **Table column resizing:** Grid.js result table columns are now resizable by dragging column borders.
- **Keyboard shortcuts:** Press `/` to focus the chat input from anywhere, `Escape` to blur it.

#### Accessibility
- **`prefers-reduced-motion` support:** All animations and transitions are disabled for users with reduced motion preferences. Scan-line overlay is also hidden.

### v3.5.0 - Remove Forensic UDFs (Feb 2026)

#### Removed
- **12 forensic SQL UDFs:** Timestamp converters (`unix_to_datetime`, `webkit_to_datetime`, `ios_to_datetime`, `filetime_to_datetime`), encoding functions (`encode_base64`, `decode_base64`, `to_hex`, `decode_hex`), and pattern extractors (`extract_email`, `extract_ip`, `extract_url`, `extract_phone`). Never used in practice — dedicated tools handle these tasks better. Removes ~136 lines of dead code and the `register_custom_functions()` helper.
- **UDF section from LLM system prompt:** Saves ~120 tokens per query by no longer listing forensic functions in the prompt sent to the LLM.
- **Unused imports:** `base64` and `timedelta` (only used by removed UDFs).

#### Fixes
- **ASCII art on Windows:** Added `Cascadia Mono` to the welcome screen font stack before `Consolas`. Cascadia Mono ships with Windows 10 1903+ and renders Unicode block characters at consistent monospace widths, fixing the crooked "y"/"d" on machines without JetBrains Mono or Fira Code.

### v3.4.3 - Shimmer Status Bar (Feb 2026)

#### Features
- **Shimmer Status Bar:** Claude Code-style activity indicator above the chat input. Displays cycling status messages ("Reading schema...", "Analyzing question...", "Generating SQL...", "Preparing response...") with an amber gradient shimmer animation while the LLM streams its response. Slides in when a question is sent and collapses smoothly after the stream completes (minimum 2.5s display). Messages appear in random order each time.
- **Shimmer Redesign:** Inverted shimmer gradient — text is always amber with a white light wash sweeping left-to-right over it (matching Claude Code's style). Added animated magnifying glass icon with gentle pulse + rotate animation. Shimmer speed now varies slightly (1.8s–2.5s) between message rotations for a more organic feel.

### v3.4.2 - Security & Cross-Platform Bug Fixes (Feb 2026)

#### Security
- **XSS in HTML Export:** All dynamic content in exported forensic reports (user messages, SQL queries, query result headers/values, analyst notes) is now properly escaped via `html_escape()`. Previously, malicious data in database columns could execute JavaScript when an exported report was opened.

#### Fixes
- **Modal Escape Handler Leak:** Closing modals via cancel button or overlay click now properly removes the `keydown` listener. Previously, each open/close cycle left an orphaned Escape key handler on `document`.
- **Path Extension Replacement:** CSV/SQL-to-DB conversion now uses `os.path.splitext()` instead of string `.replace()`, preventing path corruption if `.csv` or `.sql` appeared in directory names.
- **Query Memory Usage:** `fetchall()` replaced with `fetchmany(2001)` so large tables no longer load all rows into memory before truncating to 2000.
- **Empty Filename Fallback:** If `secure_filename()` returns an empty string (all-special-character filenames), a UUID-based fallback name is generated.
- **Windows Hostname in Export:** Forensic report header now uses `socket.gethostname()` (cross-platform) instead of `os.uname()` which doesn't exist on Windows.
- **SQL File Encoding:** `.sql` file import now explicitly uses UTF-8 encoding instead of system default, fixing garbled text on Windows with non-ASCII SQL content.
- **`run.bat` Python 3 Check:** Windows launcher now verifies the Python version is 3.x, matching the existing check in `run.sh`.

### v3.4.1 - Table Header Fix + CSV Encoding (Feb 2026)

#### Fixes
- **Sticky Header Clipping:** Fixed table column headers clipping through content above when scrolling within paginated Grid.js tables. Removed redundant `fixedHeader` and inline sticky styles that conflicted with CSS rules. Added scroll-to-top reset on pagination to prevent stale scroll state.
- **CSV Encoding:** Non-UTF8 CSV files (Windows-1252, Latin-1, etc.) now import gracefully instead of failing silently.

### v3.4.0 - Chart Visualization + Schema ER Diagram (Feb 2026)

#### Features
- **Chart Visualization:** "Chart" button on every query result table. Auto-detects bar, line, pie, or scatter chart type based on column data types. Chart type selector toggles between types. Charts respect dark/light theme and update on theme change.
- **Schema ER Diagram:** "Schema Diagram" button in sidebar opens near-full-screen modal with interactive SVG entity-relationship diagram. Force-directed layout clusters related tables. Drag tables, scroll to zoom, pan background. Click table to highlight its connections. No external library — pure SVG + vanilla JS.

#### Backend
- New endpoint `/api/schema/diagram` returns table columns, types, PKs, and FK relationships as JSON.

#### Dependencies
- Chart.js 4.x vendored in `static/lib/chart.umd.min.js`

### v3.3.2 - One-Line Installer Scripts (Feb 7, 2026)

#### Features
- **curl | sh installer (Linux/macOS):** `curl -fsSL <url> | sh` downloads source archive from GitHub and extracts to `~/yourSQLfriend` — no git required.
- **PowerShell installer (Windows):** `irm <url> | iex` downloads zip archive and extracts via `Expand-Archive` — no git required.
- **Update support:** Re-run with `--update` flag to replace an existing installation.
- **Custom install path:** Set `INSTALL_DIR` env var to change install location.
- **Prerequisite checks:** Both scripts verify Python 3.10+, download tools (curl/wget), and provide clear error messages.

#### Docs
- **README updated:** One-liner install commands are now the primary Quick Start method; git clone moved to alternative.

### v3.3.1 - Responsive Table Fix + Persistent ASCII Banner (Feb 7, 2026)

#### Fixes
- **Table Overflow Fix:** Grid.js result tables no longer spill outside chat bubbles at narrow viewport widths. Added overflow containment on bot message containers and horizontal scroll on the results wrapper.
- **ASCII Art Banner Persistence:** Minimized welcome banner no longer disappears when scrolling through chat messages. On first message, the banner is moved above the scrollable chat area so it stays pinned as a compact header bar.
- **Transition Scoping:** Welcome screen CSS transition narrowed from `all` to specific properties (`padding`, `min-height`) to prevent visual artifacts during minimize.

### v3.3 - Browser-First Pivot + PWA Support (Feb 7, 2026)

#### Architecture Change
- **Dropped pywebview/PyInstaller** — Embraces the browser as the UI runtime for superior CSS rendering, right-click menus, scrollbar behavior, and theme support.
- **PWA Support:** Added `manifest.json` and service worker so Chrome/Edge/Brave users can "Install" the app as a standalone window with desktop icon.
- **Launcher Scripts:** Added `run.sh` (Linux/macOS) and `run.bat` (Windows) — one-command setup that creates venv, installs deps, and opens the browser.
- **Auto-Browser-Open:** `python app.py` now auto-opens the default browser (like Jupyter). Use `--no-browser` to disable.
- **CLI Flags:** Added `--port` and `--host` arguments to `app.py` for flexible deployment.

#### Removed
- Deleted `main.py` (pywebview desktop wrapper)
- Deleted `build_linux.sh`, `build_windows.bat`, `yourSQLfriend.spec` (PyInstaller build infrastructure)
- Removed `pywebview>=5.0` from `requirements.txt`
- Removed `get_base_path()` / `sys._MEIPASS` PyInstaller path resolution from `app.py`
- Removed `/upload_path` route from `app.py` (pywebview-only endpoint)
- Removed ~120 lines of pywebview-specific JS: file dialog setup, desktop context menu, desktop export path, pywebview timing workarounds
- Removed desktop context menu CSS styles

---

### Earlier History (v1.1–v3.2)

Versions 3.0–3.2 explored packaging as a native desktop app via pywebview and PyInstaller. That approach was superseded by the browser-first PWA architecture in v3.3. The desktop-specific build scripts, fixes, and workarounds from those versions have been removed.

Key milestones from the pre-PWA era:

- **v3.2** — LLM pipeline overhaul: richer schema context (DDL + foreign keys + sample rows), decision framework for SQL vs plain-language answers, few-shot examples in system prompt
- **v3.1** — SQL auto-retry on error, enriched schema with column types and constraints, security hardening (14 bare `except:` fixes, quoted PRAGMA table names), ARIA accessibility on modals, favicon
- **v3.0** — Version display endpoint, LLM connection guidance in sidebar, refresh button with confirmation modal
- **v2.5** — Dual LLM provider support (LM Studio + Ollama) with status polling, dynamic model selection, XSS prevention in exports and search
- **v2.4** — Custom confirmation/alert modals with focus management
- **v2.2** — Digital Forensics Terminal theme (JetBrains Mono, amber/cyan palette, scan-line effects, slide-in animations)
- **v2.0** — Dark/light theme toggle, Search All Tables, 12 forensic SQL functions (removed in v3.5.0), multi-column sorting
- **v1.7** — CTE (WITH clause) support, EXPLAIN/PRAGMA support, database-level read-only enforcement (`mode=ro` + `query_only`)
- **v1.6** — Grid.js interactive tables, forensic annotations on messages, syntax highlighting
- **v1.5** — Drag-and-drop file upload, persistent welcome banner
- **v1.4** — SHA256 evidence hashing, audit logging, forensic export headers, CSV/SQL file import, file validation, backend timeouts
- **v1.2** — Token usage tracking with hover breakdown
- **v1.1** — Chat export styling, upload confirmation dialogs
